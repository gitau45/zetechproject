<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Manage Candidates | Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

body {
  background: linear-gradient(to bottom right, #fff, #e6f0ff);
  min-height: 100vh;
}

.header {
  background: #0a3d91;
  color: #fff;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header h2 {
  font-weight: 500;
  font-size: 1.2rem;
}

.header-buttons {
  display: flex;
  gap: 8px;
}

.logout-btn, .back-btn {
  background: #fff;
  color: #0a3d91;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.85rem;
  white-space: nowrap;
}

.logout-btn:hover, .back-btn:hover {
  background: #f2f2f2;
}

.container {
  padding: 16px;
}

.form-card, .table-card {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  margin-bottom: 20px;
}

.form-card h3, .table-card h3 {
  margin-bottom: 15px;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
}

.form-group {
  margin-bottom: 15px;
}

label {
  display: block;
  margin-bottom: 5px;
  color: #555;
  font-size: 0.9rem;
  font-weight: 500;
}

input, select {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 0.95rem;
  background-color: #fff;
  -webkit-appearance: none;
  appearance: none;
}

input:focus, select:focus {
  outline: none;
  border-color: #0a3d91;
  box-shadow: 0 0 0 2px rgba(10,61,145,0.1);
}

button {
  padding: 12px 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

button:active {
  transform: scale(0.98);
}

.add-btn {
  background: #0a3d91;
  color: #fff;
  width: 100%;
  margin-top: 5px;
}

.delete-btn {
  background: #d9534f;
  color: #fff;
  padding: 6px 12px;
  font-size: 0.8rem;
  border-radius: 6px;
}

/* Table Styles - Mobile Optimized */
.table-wrapper {
  overflow-x: auto;
  margin: 0 -5px;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
}

th, td {
  padding: 12px 8px;
  border-bottom: 1px solid #eee;
  text-align: left;
  font-size: 0.85rem;
}

th {
  background: #f8f9fa;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

td {
  color: #555;
}

.no-data {
  text-align: center;
  padding: 20px;
  color: #777;
  font-style: italic;
}

/* Badge Styles */
.campus-badge {
  background: #e6f7e6;
  color: #2e7d32;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  display: inline-block;
}

.dept-badge {
  background: #e6f0ff;
  color: #0a3d91;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  display: inline-block;
}

.election-badge {
  background: #fff3cd;
  color: #856404;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  display: inline-block;
}

/* Filter Bar */
.filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.filter-select {
  min-width: 200px;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 0.9rem;
}

/* Mobile-specific improvements */
@media (max-width: 480px) {
  .header {
    padding: 10px 12px;
  }
  
  .header h2 {
    font-size: 1rem;
  }
  
  .logout-btn, .back-btn {
    padding: 5px 8px;
    font-size: 0.75rem;
  }
  
  .container {
    padding: 12px;
  }
  
  .form-card, .table-card {
    padding: 15px;
  }
  
  input, select {
    padding: 10px;
    font-size: 0.9rem;
  }
  
  button {
    padding: 10px;
  }
  
  .add-btn {
    font-size: 0.9rem;
  }
  
  th, td {
    padding: 10px 5px;
    font-size: 0.8rem;
  }
  
  .delete-btn {
    padding: 5px 8px;
    font-size: 0.75rem;
  }

  .filter-bar {
    flex-direction: column;
    gap: 8px;
  }

  .filter-select {
    width: 100%;
    min-width: auto;
  }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  input, select, button {
    min-height: 44px;
  }
  
  .logout-btn, .back-btn {
    min-height: 36px;
  }
  
  .delete-btn {
    min-height: 36px;
    padding: 8px 12px;
  }
}

/* Custom select arrow */
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 40px;
}

/* Disabled input styling */
input:disabled, select:disabled {
  background-color: #f5f5f5;
  color: #666;
  border-color: #ddd;
  opacity: 0.7;
}

/* Card hover effect (optional) */
.form-card, .table-card {
  transition: transform 0.2s ease;
}

.form-card:active, .table-card:active {
  transform: scale(0.99);
}

/* Better spacing for labels and inputs */
label {
  margin-bottom: 4px;
}

/* Success/Error message styling (if needed) */
.alert {
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 0.9rem;
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
</style>
</head>
<body>

<div class="header">
  <h2>üë• Manage Candidates</h2>
  <div class="header-buttons">
    <button class="back-btn" onclick="goBack()">‚Üê Back</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">

  <!-- CREATE CANDIDATE -->
  <div class="form-card">
    <h3>‚ûï Add New Candidate</h3>

    <div class="form-group">
      <label for="campus">Campus *</label>
      <select id="campus" onchange="filterElectionsByCampus()">
        <option value="">Select Campus</option>
      </select>
    </div>

    <div class="form-group">
      <label for="election">Election *</label>
      <select id="election" onchange="updatePositionAndFilter()">
        <option value="">Select Election</option>
      </select>
    </div>

    <div class="form-group">
      <label for="student">Select Student *</label>
      <select id="student">
        <option value="">Select Student</option>
      </select>
    </div>

    <div class="form-group">
      <label for="position">Position *</label>
      <input type="text" id="position" placeholder="Position (e.g., President, Treasurer)">
    </div>

    <div class="form-group" id="departmentGroup" style="display: none;">
      <label for="department">Department</label>
      <select id="department" disabled>
        <option value="">Auto-filled from student</option>
      </select>
    </div>

    <button class="add-btn" id="createBtn">Add Candidate</button>
  </div>

  <!-- CANDIDATES TABLE -->
  <div class="table-card">
    <h3>üìã Existing Candidates</h3>
    
    <!-- Filter Bar -->
    <div class="filter-bar">
      <select id="campusFilter" class="filter-select" onchange="filterCandidates()">
        <option value="">All Campuses</option>
      </select>
      <select id="electionFilter" class="filter-select" onchange="filterCandidates()">
        <option value="">All Elections</option>
      </select>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Position</th>
            <th>Election</th>
            <th>Campus</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="candidatesTable"></tbody>
      </table>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global variables
let campuses = {};
let departments = {};
let elections = {};
let students = [];
let allCandidates = [];

// ============================
// SESSION CHECK
// ============================
document.addEventListener("DOMContentLoaded", async () => {
  const adminSession = JSON.parse(sessionStorage.getItem("adminSession"));
  if(!adminSession || adminSession.role !== "admin"){
    alert("Access denied! Admins only.");
    window.location.href = "admin-login.html";
    return;
  }

  await loadCampuses();
  await loadDepartments();
  await loadStudents();
  await loadElections();
  await loadCandidates();
});

// ============================
// LOGOUT & BACK
// ============================
window.logout = function(){ 
  sessionStorage.removeItem("adminSession"); 
  window.location.href="admin-login.html"; 
}

window.goBack = function(){
    if (document.referrer) window.history.back();
    else window.location.href = "admin-dashboard.html";
}

// ============================
// LOAD CAMPUSES
// ============================
async function loadCampuses(){
  const campusSelect = document.getElementById("campus");
  const campusFilter = document.getElementById("campusFilter");
  campusSelect.innerHTML = "<option value=''>Select Campus</option>";
  campusFilter.innerHTML = "<option value=''>All Campuses</option>";
  
  try{
    const snap = await getDocs(collection(db, "campus"));
    snap.forEach(docu => {
      const campusData = docu.data();
      const campusName = campusData.name || docu.id;
      campuses[docu.id] = campusName;
      campusSelect.innerHTML += `<option value="${docu.id}">${campusName}</option>`;
      campusFilter.innerHTML += `<option value="${docu.id}">${campusName}</option>`;
    });
  }catch(err){ 
    console.error("Error loading campuses:", err); 
  }
}

// ============================
// LOAD DEPARTMENTS
// ============================
async function loadDepartments(){
  try{
    const snap = await getDocs(collection(db, "departments"));
    snap.forEach(docu => {
      const deptData = docu.data();
      departments[docu.id] = deptData.name || docu.id;
    });
  }catch(err){ console.error("Error loading departments:", err); }
}

// ============================
// LOAD STUDENTS
// ============================
async function loadStudents(){
  try{
    const snap = await getDocs(collection(db, "students"));
    students = snap.docs.map(d => {
      const data = d.data();
      return {
        id: d.id,
        fullName: data.fullName || "Unnamed Student",
        departmentId: data.departmentId || "",
        campusId: data.campusId || "",
        admissionNumber: data.admissionNumber || ""
      };
    });
    populateStudentDropdown();
  }catch(err){ console.error("Error loading students:", err); }
}

// ============================
// POPULATE STUDENT DROPDOWN (filtered by campus)
// ============================
function populateStudentDropdown(campusId = null){
  const studentSelect = document.getElementById("student");
  studentSelect.innerHTML = "<option value=''>Select Student</option>";
  
  let filteredStudents = students;
  if(campusId) {
    filteredStudents = students.filter(s => s.campusId === campusId);
  }
  
  filteredStudents.forEach(s => {
    const deptName = departments[s.departmentId] || "N/A";
    const campusName = campuses[s.campusId] || "N/A";
    studentSelect.innerHTML += `<option value="${s.id}" 
      data-fullname="${s.fullName}" 
      data-department="${s.departmentId}"
      data-campus="${s.campusId}">
      ${s.fullName} (${s.admissionNumber}) - ${deptName} - ${campusName}
    </option>`;
  });
  
  if(filteredStudents.length === 0) {
    studentSelect.innerHTML = "<option value=''>No students in this campus</option>";
  }
}

// ============================
// LOAD ELECTIONS
// ============================
async function loadElections(){
  const electionSelect = document.getElementById("election");
  const electionFilter = document.getElementById("electionFilter");
  electionSelect.innerHTML = "<option value=''>Select Election</option>";
  electionFilter.innerHTML = "<option value=''>All Elections</option>";
  
  try{
    const snap = await getDocs(collection(db, "elections"));
    snap.forEach(docu => {
      const e = docu.data();
      elections[docu.id] = e;
      
      // Only show unpublished elections for adding candidates
      if(!e.published) {
        electionSelect.innerHTML += `<option value="${docu.id}" 
          data-level="${e.level}" 
          data-department="${e.departmentId || ''}"
          data-campus="${e.campusId || ''}">
          ${e.name} (${e.level})
        </option>`;
      }
      
      // Show all elections in filter
      electionFilter.innerHTML += `<option value="${docu.id}" 
        data-campus="${e.campusId || ''}">
        ${e.name} (${e.level})
      </option>`;
    });
  }catch(err){ console.error("Error loading elections:", err); }
}

// ============================
// FILTER ELECTIONS BY CAMPUS
// ============================
window.filterElectionsByCampus = function(){
  const campusId = document.getElementById("campus").value;
  const electionSelect = document.getElementById("election");
  
  // Reset student dropdown based on campus
  populateStudentDropdown(campusId);
  
  // Filter elections by campus
  const options = electionSelect.options;
  for(let i = 1; i < options.length; i++) { // Start from 1 to skip placeholder
    const option = options[i];
    const electionCampus = option.dataset.campus;
    if(campusId && electionCampus !== campusId) {
      option.style.display = "none";
    } else {
      option.style.display = "block";
    }
  }
  
  // Reset selection
  electionSelect.value = "";
  document.getElementById("position").value = "";
}

// ============================
// UPDATE POSITION FIELD AND FILTER STUDENTS
// ============================
window.updatePositionAndFilter = function(){
  const electionSelect = document.getElementById("election");
  const positionInput = document.getElementById("position");
  const selectedElection = electionSelect.selectedOptions[0];
  
  if(!selectedElection) return;

  const level = selectedElection.dataset.level;
  const campusId = selectedElection.dataset.campus;
  
  // Filter students by the election's campus
  populateStudentDropdown(campusId);
  
  if(level === "executive"){
    positionInput.disabled = false;
    positionInput.value = "";
    positionInput.placeholder = "Position (e.g., President, Secretary)";
  } else {
    positionInput.disabled = true;
    positionInput.value = "Departmental Representative";
  }
}

// ============================
// CREATE CANDIDATE
// ============================
document.getElementById("createBtn").addEventListener("click", async ()=>{
  const studentSelect = document.getElementById("student");
  const studentId = studentSelect.value;
  const studentOption = studentSelect.selectedOptions[0];
  
  if(!studentOption) {
    alert("Please select a student");
    return;
  }
  
  const fullName = studentOption.dataset.fullname;
  const departmentId = studentOption.dataset.department;
  const campusId = studentOption.dataset.campus;
  const electionId = document.getElementById("election").value;
  const position = document.getElementById("position").value.trim();

  if(!studentId || !fullName || !electionId || !position){
    alert("Please fill all required fields!");
    return;
  }

  // Check if candidate already exists for this election
  const candidateExists = allCandidates.some(c => 
    c.studentId === studentId && c.electionId === electionId
  );
  
  if(candidateExists) {
    alert("This student is already a candidate in this election!");
    return;
  }

  try{
    await addDoc(collection(db, "candidates"), {
      studentId,
      fullName,
      electionId,
      campusId,
      departmentId,
      position,
      votes: 0,
      createdAt: new Date()
    });

    alert("‚úÖ Candidate added successfully!");
    
    // Clear form
    studentSelect.value = "";
    document.getElementById("position").value = "";
    document.getElementById("election").value = "";
    document.getElementById("campus").value = "";
    
    // Refresh candidates list
    await loadCandidates();
    
    // Reset student dropdown
    populateStudentDropdown();
    
  }catch(err){ 
    console.error(err); 
    alert("‚ùå Error adding candidate: " + err.message); 
  }
});

// ============================
// LOAD CANDIDATES
// ============================
async function loadCandidates(){
  const table = document.getElementById("candidatesTable");
  table.innerHTML = "";

  try{
    const snap = await getDocs(collection(db, "candidates"));
    allCandidates = [];
    
    if(snap.empty){
      table.innerHTML = "<tr><td colspan='6' class='no-data'>No candidates found.</td></tr>";
      return;
    }

    snap.forEach(docu => {
      allCandidates.push({
        id: docu.id,
        ...docu.data()
      });
    });
    
    displayCandidates();
    
  }catch(err){ 
    console.error("Error loading candidates:", err);
    table.innerHTML = `<tr><td colspan="6" class="no-data">Error loading candidates</td></tr>`;
  }
}

// ============================
// DISPLAY CANDIDATES (with filters)
// ============================
function displayCandidates() {
  const table = document.getElementById("candidatesTable");
  const campusFilter = document.getElementById("campusFilter").value;
  const electionFilter = document.getElementById("electionFilter").value;
  
  let filtered = [...allCandidates];
  
  if(campusFilter) {
    filtered = filtered.filter(c => c.campusId === campusFilter);
  }
  
  if(electionFilter) {
    filtered = filtered.filter(c => c.electionId === electionFilter);
  }
  
  if(filtered.length === 0) {
    table.innerHTML = "<tr><td colspan='6' class='no-data'>No candidates match filters</td></tr>";
    return;
  }
  
  table.innerHTML = "";
  
  filtered.forEach(c => {
    const deptName = departments[c.departmentId] || c.departmentId || "-";
    const campusName = campuses[c.campusId] || c.campusId || "N/A";
    const electionName = elections[c.electionId]?.name || c.electionId || "-";
    const electionLevel = elections[c.electionId]?.level || "";
    
    table.innerHTML += `<tr>
      <td><strong>${c.fullName || "-"}</strong></td>
      <td><span class="election-badge">${c.position || "-"}</span></td>
      <td>${electionName} <span style="color:#666; font-size:0.7rem;">(${electionLevel})</span></td>
      <td><span class="campus-badge">${campusName}</span></td>
      <td><span class="dept-badge">${deptName}</span></td>
      <td>
        <button class="delete-btn" onclick="deleteCandidate('${c.id}')">
          <i class="fas fa-trash"></i> Delete
        </button>
      </td>
    </tr>`;
  });
}

// ============================
// FILTER CANDIDATES
// ============================
window.filterCandidates = function() {
  displayCandidates();
}

// ============================
// DELETE CANDIDATE
// ============================
window.deleteCandidate = async function(id){
  if(!confirm("‚ö†Ô∏è Are you sure you want to delete this candidate?")) return;
  
  try{
    const docRef = doc(db, "candidates", id);
    await deleteDoc(docRef);
    alert("‚úÖ Candidate deleted successfully!");
    await loadCandidates();
  }catch(err){ 
    console.error(err); 
    alert("‚ùå Error deleting candidate!"); 
  }
}
</script>

<!-- Add Font Awesome for icons (optional but nice) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
