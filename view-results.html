<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Election Publishing Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

body {
  margin: 0;
  background: #f5f7fb;
  min-height: 100vh;
}

/* HEADER */
.header {
  background: #0a3d91;
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header div:first-child {
  font-weight: 600;
  font-size: 1.1rem;
}

.header-buttons {
  display: flex;
  gap: 8px;
}

.btn {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.85rem;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.btn:active {
  transform: scale(0.96);
}

.back {
  background: white;
  color: #0a3d91;
}

.logout {
  background: #ef4444;
  color: white;
}

/* DASHBOARD */
.container {
  padding: 16px;
  max-width: 1200px;
  margin: auto;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 6px 25px rgba(0,0,0,.08);
  margin-bottom: 20px;
}

.card h2 {
  font-size: 1.3rem;
  margin-bottom: 15px;
}

.card h3 {
  font-size: 1.1rem;
  margin-bottom: 15px;
}

/* ANALYTICS */
.analytics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 15px;
}

.metric {
  background: #fff;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,.08);
  text-align: center;
}

.metric h3 {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 8px;
}

.metric p {
  font-size: 1.5rem;
  font-weight: 600;
  color: #0a3d91;
}

/* TABLE */
.table-wrapper {
  overflow-x: auto;
  margin: 0 -5px;
  -webkit-overflow-scrolling: touch;
  border-radius: 8px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 650px;
}

th, td {
  padding: 12px 8px;
  border-bottom: 1px solid #eee;
  font-size: .85rem;
  text-align: left;
}

th {
  background: #f8f9fa;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

td {
  color: #555;
}

.winner {
  color: #16a34a;
  font-weight: 600;
}

/* BUTTONS */
.publish-btn {
  background: #22c55e;
  color: white;
  margin-right: 8px;
  margin-bottom: 8px;
}

.unpublish-btn {
  background: #f59e0b;
  color: white;
  margin-bottom: 8px;
}

.save-btn {
  background: #0a3d91;
  color: white;
  margin-top: 10px;
  width: 100%;
}

/* FORM ELEMENTS */
select {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 0.95rem;
  background-color: #fff;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 40px;
}

select:focus {
  outline: none;
  border-color: #0a3d91;
  box-shadow: 0 0 0 2px rgba(10,61,145,0.1);
}

hr {
  margin: 20px 0;
  border: none;
  border-top: 1px solid #eee;
}

/* HEADER INFO */
#headerInfo {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

#headerInfo h3 {
  font-size: 1.1rem;
  margin-bottom: 5px;
}

#headerInfo p {
  color: #666;
}

/* BUTTON GROUP */
.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 15px;
}

/* Mobile-specific improvements */
@media (max-width: 480px) {
  .header {
    padding: 10px 12px;
  }
  
  .header div:first-child {
    font-size: 0.95rem;
  }
  
  .btn {
    padding: 6px 10px;
    font-size: 0.75rem;
  }
  
  .container {
    padding: 12px;
  }
  
  .card {
    padding: 15px;
  }
  
  .card h2 {
    font-size: 1.2rem;
  }
  
  .card h3 {
    font-size: 1rem;
  }
  
  .analytics {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  
  .metric {
    padding: 12px;
  }
  
  .metric h3 {
    font-size: 0.85rem;
  }
  
  .metric p {
    font-size: 1.3rem;
  }
  
  th, td {
    padding: 10px 5px;
    font-size: 0.8rem;
  }
  
  select {
    padding: 10px;
    font-size: 0.9rem;
  }
  
  .button-group {
    flex-direction: column;
  }
  
  .publish-btn, .unpublish-btn {
    width: 100%;
    margin-right: 0;
  }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  select, .btn, .save-btn {
    min-height: 44px;
  }
  
  .btn {
    min-height: 40px;
  }
}

/* Small phones */
@media (max-width: 350px) {
  .header div:first-child {
    font-size: 0.85rem;
  }
  
  .btn {
    padding: 5px 8px;
    font-size: 0.7rem;
  }
  
  .metric p {
    font-size: 1.2rem;
  }
}

/* Winner badge */
.winner-badge {
  display: inline-block;
  background: #16a34a;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
}

/* Status badge */
.status-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}

.status-published {
  background: #22c55e;
  color: white;
}

.status-draft {
  background: #f59e0b;
  color: white;
}

/* Loading state */
.loading {
  opacity: 0.7;
  pointer-events: none;
}

/* Alert styling */
.alert {
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 0.9rem;
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

/* Info text */
.info-text {
  font-size: 0.85rem;
  color: #666;
  margin-top: 5px;
}

/* Security badge */
.security-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #e8f0fe;
  color: #0a3d91;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  margin-left: 8px;
}
</style>
</head>
<body>

<div class="header">
  <div>Election Publishing Dashboard <span class="security-badge"><i class="fas fa-shield-alt"></i> Secure</span></div>
  <div class="header-buttons">
    <button class="btn back" onclick="history.back()">‚Üê Back</button>
    <button class="btn logout" onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">

  <div class="card">
    <h2>Election Control Panel</h2>
    
    <div id="headerInfo"></div>
    
    <div id="analytics" class="analytics"></div>
    
    <div class="button-group">
      <button id="publishBtn" class="btn publish-btn" onclick="publishElection()">üì¢ Publish Results</button>
      <button id="unpublishBtn" class="btn unpublish-btn" onclick="unpublishElection()">üîí Unpublish</button>
    </div>

    <hr>

    <h3>Manual Role Override</h3>
    
    <select id="studentRoleSelect"></select>
    
    <button class="btn save-btn" onclick="saveRoleOverride()">
      üíæ Save Role Change
    </button>
  </div>

  <div class="card">
    <h3>Vote Summary Table</h3>
    
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Candidate</th>
            <th>Position</th>
            <th>Votes</th>
            <th>Winner</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  doc,
  updateDoc,
  writeBatch,
  runTransaction
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* SESSION WITH ENHANCED SECURITY */
const session = JSON.parse(sessionStorage.getItem("adminSession") || "{}");

// Validate session with timestamp
const validateSession = () => {
  if (!session || session.role !== "admin") {
    return false;
  }
  
  // Check if session is expired (24 hours)
  if (session.timestamp) {
    const sessionAge = Date.now() - session.timestamp;
    if (sessionAge > 24 * 60 * 60 * 1000) {
      sessionStorage.removeItem("adminSession");
      return false;
    }
  }
  
  return true;
};

if (!validateSession()) {
  alert("Admin only - Session expired or invalid");
  location = "admin-login.html";
}

// Update session timestamp on activity
const updateSessionTimestamp = () => {
  if (session) {
    session.timestamp = Date.now();
    sessionStorage.setItem("adminSession", JSON.stringify(session));
  }
};

/* GLOBAL STATE */
let currentElectionId = null;
let operationInProgress = false;

/* CSRF Protection */
const generateCSRFToken = () => {
  return Math.random().toString(36).substring(2) + Date.now().toString(36);
};

let csrfToken = sessionStorage.getItem('csrfToken') || generateCSRFToken();
sessionStorage.setItem('csrfToken', csrfToken);

/* LOAD SYSTEM */
async function loadDashboard() {
  updateSessionTimestamp();
  
  const table = document.getElementById("resultsTable");
  const analytics = document.getElementById("analytics");
  const header = document.getElementById("headerInfo");

  table.innerHTML = "";
  analytics.innerHTML = "";
  header.innerHTML = "";

  try {
    const electionsSnap = await getDocs(collection(db, "elections"));
    const electionDoc = electionsSnap.docs[0];

    if (!electionDoc) return;

    const election = electionDoc.data();
    currentElectionId = electionDoc.id;

    /* HEADER PANEL */
    header.innerHTML = `
      <h3>${escapeHtml(election.name)}</h3>
      <p>Published: <span class="status-badge ${election.published ? 'status-published' : 'status-draft'}">${election.published ? "YES" : "NO"}</span></p>
    `;

    /* BUTTON VISIBILITY */
    document.getElementById("publishBtn").style.display =
      election.published ? "none" : "inline-block";

    document.getElementById("unpublishBtn").style.display =
      election.published ? "inline-block" : "none";

    /* LOAD CANDIDATES WITH VALIDATION */
    const candidatesSnap = await getDocs(
      query(collection(db, "candidates"),
        where("electionId", "==", currentElectionId))
    );

    let groups = {};
    let totalVotes = 0;

    /* ROLE SELECT POPULATION */
    const studentSelect = document.getElementById("studentRoleSelect");
    studentSelect.innerHTML = "<option value=''>Select student to promote</option>";

    const studentsSnap = await getDocs(collection(db, "students"));

    studentsSnap.forEach(s => {
      const d = s.data();
      if (d && d.fullName) {
        studentSelect.innerHTML += `
          <option value="${escapeHtml(s.id)}">
            ${escapeHtml(d.fullName)} (${escapeHtml(d.role || "student")})
          </option>
        `;
      }
    });

    candidatesSnap.forEach(docSnap => {
      const d = docSnap.data();
      if (!d) return;
      
      const pos = d.position || "Representative";
      const votes = parseInt(d.votes) || 0;

      totalVotes += votes;

      if (!groups[pos]) groups[pos] = [];

      groups[pos].push({
        id: docSnap.id,
        name: d.fullName || "Unknown",
        votes: votes,
        admissionNumber: d.admissionNumber || d.studentId || "",
        position: pos
      });
    });

    /* WINNER ENGINE WITH TIE DETECTION */
    let winners = {};
    let ties = {};

    for (const pos in groups) {
      groups[pos].sort((a, b) => b.votes - a.votes);
      
      if (groups[pos][0]) {
        winners[pos] = groups[pos][0];
        
        // Check for ties
        if (groups[pos][1] && groups[pos][1].votes === groups[pos][0].votes) {
          ties[pos] = true;
        }
      }
    }

    /* ANALYTICS */
    analytics.innerHTML = `
      <div class="metric">
        <h3>Total Votes</h3>
        <p>${totalVotes}</p>
      </div>
      <div class="metric">
        <h3>Status</h3>
        <p>${election.published ? "Published" : "Draft"}</p>
      </div>
      <div class="metric">
        <h3>Election ID</h3>
        <p style="font-size: 0.9rem;">${escapeHtml(currentElectionId.substring(0, 8))}...</p>
      </div>
    `;

    /* TABLE RENDER */
    for (const pos in groups) {
      groups[pos].forEach(c => {
        const isWinner = winners[pos] &&
          c.admissionNumber === winners[pos].admissionNumber;
        
        const hasTie = ties[pos] && isWinner;

        table.innerHTML += `
          <tr>
            <td>${escapeHtml(c.name)}</td>
            <td>${escapeHtml(c.position)}</td>
            <td><strong>${c.votes}</strong></td>
            <td class="winner">${isWinner ? (hasTie ? 'ü§ù TIE' : 'üèÜ YES') : 'NO'}</td>
            <td><span class="status-badge ${election.published ? 'status-published' : 'status-draft'}">${election.published ? "Published" : "Draft"}</span></td>
          </tr>
        `;
      });
    }
  } catch (error) {
    console.error("Error loading dashboard:", error);
    showAlert("Error loading data", "error");
  }
}

/* SECURE PUBLISH ENGINE WITH TRANSACTIONS */
window.publishElection = async () => {
  if (!currentElectionId) return;
  if (operationInProgress) {
    alert("Operation already in progress");
    return;
  }

  if (!confirm("‚ö†Ô∏è Publish results? Winners will be promoted to rep role. This action cannot be undone.")) return;

  operationInProgress = true;
  const publishBtn = document.getElementById("publishBtn");
  publishBtn.classList.add("loading");
  publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';

  try {
    updateSessionTimestamp();
    
    // Use transaction for atomic operation
    await runTransaction(db, async (transaction) => {
      // Check if election is already published
      const electionRef = doc(db, "elections", currentElectionId);
      const electionDoc = await transaction.get(electionRef);
      
      if (!electionDoc.exists()) {
        throw new Error("Election not found");
      }
      
      if (electionDoc.data().published) {
        throw new Error("Election already published");
      }

      /* Get all candidates */
      const candidatesQuery = query(
        collection(db, "candidates"),
        where("electionId", "==", currentElectionId)
      );
      const candidatesSnap = await getDocs(candidatesQuery);

      let groups = {};
      const updates = [];

      candidatesSnap.forEach(docSnap => {
        const d = docSnap.data();
        const pos = d.position || "Representative";
        const votes = parseInt(d.votes) || 0;

        if (!groups[pos]) groups[pos] = [];
        groups[pos].push({
          admissionNumber: d.admissionNumber || d.studentId,
          votes: votes,
          docId: docSnap.id
        });
      });

      /* Promote winners with validation */
      for (const pos in groups) {
        groups[pos].sort((a, b) => b.votes - a.votes);
        const winner = groups[pos][0];

        // Check for ties - don't promote if tied
        if (groups[pos][1] && groups[pos][1].votes === winner.votes) {
          console.warn(`Tie detected for position: ${pos} - no winner promoted`);
          continue;
        }

        if (winner && winner.admissionNumber) {
          const studentRef = doc(db, "students", winner.admissionNumber);
          const studentDoc = await transaction.get(studentRef);
          
          if (studentDoc.exists()) {
            transaction.update(studentRef, { 
              role: "rep",
              promotedAt: new Date(),
              promotedFrom: currentElectionId
            });
          }
        }
      }

      /* Lock election */
      transaction.update(electionRef, { 
        published: true,
        publishedAt: new Date(),
        publishedBy: session.staffNumber || "admin"
      });
    });

    showAlert("‚úÖ Results published successfully!", "success");
    await loadDashboard();

  } catch (error) {
    console.error("Error publishing:", error);
    showAlert("‚ùå Error publishing: " + error.message, "error");
  } finally {
    operationInProgress = false;
    publishBtn.classList.remove("loading");
    publishBtn.innerHTML = 'üì¢ Publish Results';
  }
};

/* SECURE UNPUBLISH */
window.unpublishElection = async () => {
  if (!currentElectionId) return;
  if (operationInProgress) return;

  if (!confirm("‚ö†Ô∏è Unpublish results? This will hide published results from students.")) return;

  operationInProgress = true;
  const unpublishBtn = document.getElementById("unpublishBtn");
  unpublishBtn.classList.add("loading");
  unpublishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Unpublishing...';

  try {
    updateSessionTimestamp();

    const electionRef = doc(db, "elections", currentElectionId);
    
    await runTransaction(db, async (transaction) => {
      const electionDoc = await transaction.get(electionRef);
      
      if (!electionDoc.exists()) {
        throw new Error("Election not found");
      }
      
      transaction.update(electionRef, { 
        published: false,
        unpublishedAt: new Date(),
        unpublishedBy: session.staffNumber || "admin"
      });
    });

    showAlert("üìù Results unpublished", "success");
    await loadDashboard();

  } catch (error) {
    console.error("Error unpublishing:", error);
    showAlert("‚ùå Error unpublishing: " + error.message, "error");
  } finally {
    operationInProgress = false;
    unpublishBtn.classList.remove("loading");
    unpublishBtn.innerHTML = 'üîí Unpublish';
  }
};

/* SECURE ROLE OVERRIDE */
window.saveRoleOverride = async () => {
  if (operationInProgress) return;

  const studentSelect = document.getElementById("studentRoleSelect");
  const studentId = studentSelect.value;

  if (!studentId) {
    alert("Please select a student");
    return;
  }

  if (!confirm(`‚ö†Ô∏è Promote ${studentSelect.selectedOptions[0]?.text || 'student'} to rep role?`)) return;

  operationInProgress = true;
  const saveBtn = document.querySelector(".save-btn");
  saveBtn.classList.add("loading");
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

  try {
    updateSessionTimestamp();

    const studentRef = doc(db, "students", studentId);
    
    await runTransaction(db, async (transaction) => {
      const studentDoc = await transaction.get(studentRef);
      
      if (!studentDoc.exists()) {
        throw new Error("Student not found");
      }
      
      transaction.update(studentRef, { 
        role: "rep",
        roleUpdatedAt: new Date(),
        roleUpdatedBy: session.staffNumber || "admin"
      });
    });

    showAlert("‚úÖ Role updated successfully!", "success");
    
    // Refresh the select options
    const studentSelect = document.getElementById("studentRoleSelect");
    const studentsSnap = await getDocs(collection(db, "students"));
    
    studentSelect.innerHTML = "<option value=''>Select student to promote</option>";
    studentsSnap.forEach(s => {
      const d = s.data();
      if (d && d.fullName) {
        studentSelect.innerHTML += `
          <option value="${escapeHtml(s.id)}">
            ${escapeHtml(d.fullName)} (${escapeHtml(d.role || "student")})
          </option>
        `;
      }
    });

  } catch (err) {
    console.error("Error updating role:", err);
    showAlert("‚ùå Error updating role: " + err.message, "error");
  } finally {
    operationInProgress = false;
    saveBtn.classList.remove("loading");
    saveBtn.innerHTML = 'üíæ Save Role Change';
  }
};

/* HELPER FUNCTIONS */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showAlert(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = `
    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
    ${escapeHtml(message)}
  `;
  
  const container = document.querySelector('.container');
  container.insertBefore(alertDiv, container.firstChild);
  
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}

/* LOGOUT WITH CLEANUP */
window.logout = () => {
  if (confirm("Are you sure you want to logout?")) {
    sessionStorage.clear();
    location = "admin-login.html";
  }
};

/* Add keyboard shortcut protection */
document.addEventListener('keydown', (e) => {
  // Prevent F5 refresh during operations
  if (operationInProgress && e.key === 'F5') {
    e.preventDefault();
    alert("Operation in progress. Please wait.");
  }
});

/* Add beforeunload protection */
window.addEventListener('beforeunload', (e) => {
  if (operationInProgress) {
    e.preventDefault();
    e.returnValue = 'Operation in progress. Are you sure you want to leave?';
  }
});

/* Initialize */
loadDashboard();

</script>
</body>
</html>
