<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<meta name="theme-color" content="#0a3d91">
<title>Student Login | Zetech E-Voting</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- EmailJS Library -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
:root {
  --primary: #0a3d91;
  --primary-light: #1a4da1;
  --primary-dark: #062a66;
  --background: linear-gradient(135deg, #fff 0%, #e6f0ff 100%);
  --white: #ffffff;
  --muted: #6B7280;
  --error: #dc2626;
  --success: #16a34a;
  --warning: #f59e0b;
  --shadow: rgba(0,0,0,0.1);
  --border-radius: 24px;
  --card-radius: 20px;
  --transition: all 0.2s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

body {
  background: var(--background);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 1rem;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  width: 100%;
  max-width: 420px;
  background: var(--white);
  padding: 2rem 1.5rem;
  border-radius: var(--border-radius);
  box-shadow: 0 20px 40px rgba(10,61,145,0.15);
  animation: slideUp 0.4s ease-out;
  border: 1px solid rgba(255,255,255,0.5);
}

/* Security Badge */
.security-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  background: #f0f4fe;
  padding: 0.5rem;
  border-radius: 30px;
  margin: 0.5rem 0 1.5rem;
  font-size: 0.8rem;
  color: var(--primary);
}

.security-badge i {
  font-size: 0.9rem;
}

/* Icon Section */
.icon {
  font-size: 3.5rem;
  color: var(--primary);
  text-align: center;
  margin-bottom: 0.5rem;
  background: rgba(10,61,145,0.1);
  width: 80px;
  height: 80px;
  line-height: 80px;
  border-radius: 50%;
  margin: 0 auto 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.container h2 {
  text-align: center;
  color: var(--primary);
  margin-bottom: 0.5rem;
  font-size: 1.8rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

/* Info Text */
.info-text {
  text-align: center;
  margin: 0.5rem 0 1.5rem;
  color: var(--muted);
  font-size: 0.9rem;
  line-height: 1.5;
  padding: 0 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 30px;
}

.info-text i {
  color: var(--primary);
  font-size: 1rem;
}

/* Campus Indicator */
.campus-indicator {
  text-align: center;
  color: var(--muted);
  font-size: 0.9rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

/* Form Groups */
.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #333;
  margin-bottom: 0.5rem;
  font-weight: 600;
  font-size: 0.95rem;
}

.form-group label i {
  color: var(--primary);
  font-size: 1rem;
  width: 1.2rem;
}

/* Field Hint */
.field-hint {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.3rem;
  font-size: 0.75rem;
  color: var(--muted);
  background: #f8f9fa;
  padding: 0.4rem 0.8rem;
  border-radius: 30px;
}

.field-hint i {
  color: var(--primary);
  font-size: 0.7rem;
}

/* Input Fields */
.form-group input {
  width: 100%;
  padding: 1rem;
  border-radius: 16px;
  border: 1.5px solid #e5e7eb;
  font-size: 1rem;
  transition: var(--transition);
  background: #f8f9fa;
}

.form-group input:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 4px rgba(10,61,145,0.1);
  background: var(--white);
}

.form-group input::placeholder {
  color: #9ca3af;
  font-size: 0.9rem;
}

/* Button */
.btn {
  width: 100%;
  padding: 1rem;
  background: var(--primary);
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
  border: none;
  border-radius: 30px;
  cursor: pointer;
  transition: var(--transition);
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  box-shadow: 0 8px 16px rgba(10,61,145,0.2);
}

.btn:active {
  transform: scale(0.96);
  background: var(--primary-light);
  box-shadow: 0 4px 8px rgba(10,61,145,0.3);
}

.btn i {
  font-size: 1rem;
}

.btn.secondary {
  background: #f3f4f6;
  color: #333;
  box-shadow: none;
}

.btn.secondary:hover {
  background: #e5e7eb;
}

/* Messages */
.error, .success, .warning {
  text-align: center;
  margin-bottom: 1rem;
  padding: 0.75rem;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  animation: shake 0.3s ease-out;
}

.error {
  color: var(--error);
  background: #fee2e2;
  border: 1px solid #fecaca;
}

.success {
  color: var(--success);
  background: #dcfce7;
  border: 1px solid #bbf7d0;
}

.warning {
  color: var(--warning);
  background: #fef3c7;
  border: 1px solid #fde68a;
}

/* Back Link */
.back-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  text-align: center;
  color: var(--primary);
  margin-top: 1rem;
  text-decoration: none;
  font-size: 0.9rem;
  transition: var(--transition);
  padding: 0.75rem;
  border-radius: 30px;
  background: #f8f9fa;
}

.back-btn:active {
  background: #e5e7eb;
  transform: scale(0.96);
}

.back-btn i {
  font-size: 0.8rem;
}

/* Verification Section */
#verificationSection {
  animation: slideUp 0.3s ease-out;
}

/* Animations */
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* Touch Optimizations */
@media (hover: none) and (pointer: coarse) {
  .btn, .back-btn, input {
    min-height: 48px;
  }
  
  .form-group input {
    font-size: 16px;
  }
}

/* Small Phones */
@media (max-width: 380px) {
  .container {
    padding: 1.5rem 1rem;
  }
  
  .container h2 {
    font-size: 1.5rem;
  }
  
  .icon {
    width: 60px;
    height: 60px;
    line-height: 60px;
    font-size: 2.5rem;
  }
  
  .info-text {
    font-size: 0.8rem;
    padding: 0.5rem;
  }
  
  .form-group label {
    font-size: 0.9rem;
  }
  
  .form-group input {
    padding: 0.875rem;
  }
  
  .btn {
    padding: 0.875rem;
  }
  
  .field-hint {
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
  }
}

/* Loading State */
.btn.loading {
  opacity: 0.7;
  pointer-events: none;
}

.btn.loading i {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Input Validation */
input.error-field {
  border-color: var(--error);
  background: #fff5f5;
}

input.success-field {
  border-color: var(--success);
  background: #f0fdf4;
}

/* Timer */
.timer {
  color: var(--primary);
  font-weight: 600;
  margin-left: 0.3rem;
}
</style>
</head>
<body>

<div class="container">
  <div class="icon">
    <i class="fas fa-user-graduate"></i>
  </div>
  
  <h2>Student Login</h2>
  
  <div class="campus-indicator" id="campusIndicator">
    <i class="fas fa-map-marker-alt"></i>
    <span>Loading campus...</span>
  </div>

  <div class="security-badge">
    <i class="fas fa-shield-alt"></i>
    <span>Email Verification Required</span>
    <i class="fas fa-check-circle" style="color: #22c55e;"></i>
  </div>

  <div class="error" id="errorMsg" style="display: none;">
    <i class="fas fa-exclamation-circle"></i>
    <span></span>
  </div>
  
  <div class="success" id="successMsg" style="display: none;">
    <i class="fas fa-check-circle"></i>
    <span></span>
  </div>

  <div class="warning" id="warningMsg" style="display: none;">
    <i class="fas fa-clock"></i>
    <span></span>
  </div>

  <!-- Step 1: Login Form -->
  <div id="loginForm">
    <div class="form-group">
      <label>
        <i class="fas fa-id-card"></i>
        Admission Number
      </label>
      <input type="text" id="admissionNumber" placeholder="e.g. DCS001" autocomplete="off">
      <div class="field-hint">
        <i class="fas fa-info-circle"></i>
        <span>Enter your admission number</span>
      </div>
    </div>

    <div class="form-group">
      <label>
        <i class="fas fa-envelope"></i>
        Email Address
      </label>
      <input type="email" id="email" placeholder="student@zetech.ac.ke" autocomplete="off">
      <div class="field-hint">
        <i class="fas fa-info-circle"></i>
        <span>Your official Zetech email</span>
      </div>
    </div>

    <button class="btn" id="loginBtn">
      <i class="fas fa-paper-plane"></i>
      <span>Send Verification Code</span>
    </button>
  </div>

  <!-- Step 2: Verification Form -->
  <div id="verificationSection" style="display: none;">
    <div class="info-text" style="margin-bottom: 1.5rem;">
      <i class="fas fa-envelope-open-text"></i>
      <span>Enter the 6-digit code sent to your email</span>
    </div>

    <div class="form-group">
      <label>
        <i class="fas fa-lock"></i>
        Verification Code
      </label>
      <input type="text" id="verificationCode" placeholder="000000" maxlength="6" inputmode="numeric">
      <div class="field-hint">
        <i class="fas fa-clock"></i>
        <span>Code expires in <span id="timer">05:00</span></span>
      </div>
    </div>

    <button class="btn" id="verifyBtn" style="background: #22c55e;">
      <i class="fas fa-check-circle"></i>
      <span>Verify & Login</span>
    </button>

    <button class="btn secondary" id="resendBtn">
      <i class="fas fa-redo-alt"></i>
      <span>Resend Code</span>
    </button>
  </div>

  <a href="index.html" class="back-btn">
    <i class="fas fa-arrow-left"></i>
    Back to Home
  </a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  updateDoc, 
  serverTimestamp,
  collection,
  query,
  where,
  getDocs 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ==================== CONFIGURATION ====================
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};

// EmailJS Config - YOUR KEYS
const EMAILJS_CONFIG = {
  PUBLIC_KEY: "kQiNIL-qUYTz2EMd",
  SERVICE_ID: "service_6nmauhc",
  TEMPLATE_ID: "htHZZpZi5MHdiXaIVYOBh" // This is your template ID, not private key
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Initialize EmailJS with your public key
emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);

// ==================== 2FA FUNCTIONS ====================

// Generate random 6-digit code
function generate2FACode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// Store 2FA state
let current2FACode = null;
let pendingStudent = null;
let pendingStudentId = null;
let timerInterval = null;

// Show/hide functions
function showError(message) {
  const errorDiv = document.getElementById('errorMsg');
  const errorSpan = errorDiv.querySelector('span');
  errorSpan.textContent = message;
  errorDiv.style.display = 'flex';
  
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

function showSuccess(message) {
  const successDiv = document.getElementById('successMsg');
  const successSpan = successDiv.querySelector('span');
  successSpan.textContent = message;
  successDiv.style.display = 'flex';
  
  setTimeout(() => {
    successDiv.style.display = 'none';
  }, 3000);
}

function showWarning(message) {
  const warningDiv = document.getElementById('warningMsg');
  const warningSpan = warningDiv.querySelector('span');
  warningSpan.textContent = message;
  warningDiv.style.display = 'flex';
  
  setTimeout(() => {
    warningDiv.style.display = 'none';
  }, 5000);
}

// Timer function
function startTimer(duration) {
  const timerDisplay = document.getElementById('timer');
  let timeLeft = duration;
  
  timerInterval = setInterval(() => {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerDisplay.textContent = '00:00';
      showWarning('Code expired. Please request a new one.');
    }
    timeLeft--;
  }, 1000);
}

// ACTUAL EMAIL SENDING FUNCTION with your EmailJS keys
async function sendVerificationEmail(email, code, studentName) {
  try {
    // Template parameters - customize based on your EmailJS template
    const templateParams = {
      to_email: email,
      to_name: studentName || 'Student',
      verification_code: code,
      expiry_minutes: '5',
      from_name: 'Zetech E-Voting System',
      reply_to: 'noreply@zetech.ac.ke'
    };

    console.log('Sending email with params:', templateParams);
    console.log('Using Service ID:', EMAILJS_CONFIG.SERVICE_ID);
    console.log('Using Template ID:', EMAILJS_CONFIG.TEMPLATE_ID);

    // Send email using EmailJS with YOUR keys
    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );

    console.log('Email sent successfully:', response);
    showSuccess(`âœ… Verification code sent to ${email}`);
    return true;
    
  } catch (error) {
    console.error('Email sending failed:', error);
    showWarning('Failed to send email. Using demo mode.');
    showWarning(`Demo: Your verification code is ${code}`);
    return false;
  }
}

// ROBUST STUDENT SEARCH FUNCTION
async function findStudent(admissionNumber, email) {
  console.log('Searching for student:', { admissionNumber, email });
  
  // Method 1: Try direct document access (admission number as ID)
  try {
    const directRef = doc(db, 'students', admissionNumber);
    const directSnap = await getDoc(directRef);
    
    if (directSnap.exists()) {
      console.log('Student found by direct ID match');
      return {
        id: directSnap.id,
        data: directSnap.data(),
        method: 'direct'
      };
    }
  } catch (err) {
    console.log('Direct lookup failed:', err);
  }
  
  // Method 2: Search by admissionNumber field
  try {
    const studentsRef = collection(db, 'students');
    const q = query(studentsRef, where('admissionNumber', '==', admissionNumber));
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
      console.log('Student found by admissionNumber field');
      return {
        id: querySnapshot.docs[0].id,
        data: querySnapshot.docs[0].data(),
        method: 'field'
      };
    }
  } catch (err) {
    console.log('Field search failed:', err);
  }
  
  // Method 3: Search by email
  try {
    const studentsRef = collection(db, 'students');
    const q = query(studentsRef, where('email', '==', email));
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
      console.log('Student found by email');
      return {
        id: querySnapshot.docs[0].id,
        data: querySnapshot.docs[0].data(),
        method: 'email'
      };
    }
  } catch (err) {
    console.log('Email search failed:', err);
  }
  
  return null;
}

document.addEventListener("DOMContentLoaded", async () => {
  // Get campus from URL
  const urlParams = new URLSearchParams(window.location.search);
  const campus = urlParams.get('campus');
  
  const campusIndicator = document.getElementById('campusIndicator');
  if (campus) {
    campusIndicator.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${campus} Campus</span>`;
    sessionStorage.setItem('selectedCampus', campus);
  } else {
    const savedCampus = sessionStorage.getItem('selectedCampus');
    if (savedCampus) {
      campusIndicator.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${savedCampus} Campus</span>`;
    }
  }

  const loginBtn = document.getElementById('loginBtn');
  const verifyBtn = document.getElementById('verifyBtn');
  const resendBtn = document.getElementById('resendBtn');
  
  const admissionInput = document.getElementById('admissionNumber');
  const emailInput = document.getElementById('email');
  const codeInput = document.getElementById('verificationCode');

  // Clear messages on input
  admissionInput.addEventListener('input', () => {
    document.getElementById('errorMsg').style.display = 'none';
    admissionInput.classList.remove('error-field');
  });
  
  emailInput.addEventListener('input', () => {
    document.getElementById('errorMsg').style.display = 'none';
    emailInput.classList.remove('error-field');
  });

  codeInput.addEventListener('input', () => {
    document.getElementById('errorMsg').style.display = 'none';
    codeInput.classList.remove('error-field');
  });

  // Step 1: Send verification code
  loginBtn.addEventListener('click', async () => {
    const admissionNumber = admissionInput.value.trim().toUpperCase();
    const email = emailInput.value.trim().toLowerCase();

    // Validation
    if (!admissionNumber || !email) {
      showError('Please enter both Admission Number and Email');
      if (!admissionNumber) admissionInput.classList.add('error-field');
      if (!email) emailInput.classList.add('error-field');
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showError('Please enter a valid email address');
      emailInput.classList.add('error-field');
      return;
    }

    // Show loading
    loginBtn.classList.add('loading');
    loginBtn.innerHTML = '<i class="fas fa-spinner"></i> Verifying...';

    try {
      // Find student using robust search
      const result = await findStudent(admissionNumber, email);
      
      if (!result) {
        showError('Student not found! Please check your admission number and email.');
        admissionInput.classList.add('error-field');
        emailInput.classList.add('error-field');
        loginBtn.classList.remove('loading');
        loginBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Send Verification Code</span>';
        return;
      }

      const student = result.data;
      const studentId = result.id;

      // Verify email matches (double-check)
      if (student.email.toLowerCase() !== email) {
        showError('Email does not match our records!');
        emailInput.classList.add('error-field');
        loginBtn.classList.remove('loading');
        loginBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Send Verification Code</span>';
        return;
      }

      // Verify campus matches
      if (campus && student.campusId && student.campusId.toLowerCase() !== campus.toLowerCase()) {
        showError(`You are registered at ${student.campusId} campus. Please select the correct campus.`);
        loginBtn.classList.remove('loading');
        loginBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Send Verification Code</span>';
        return;
      }

      // Generate and send 2FA code
      current2FACode = generate2FACode();
      pendingStudent = student;
      pendingStudentId = studentId;
      pendingStudent.timestamp = Date.now();

      // Send ACTUAL verification email with your EmailJS keys
      await sendVerificationEmail(email, current2FACode, student.fullName || 'Student');

      // Switch to verification form
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('verificationSection').style.display = 'block';
      
      // Start 5-minute timer
      startTimer(300); // 300 seconds = 5 minutes

    } catch (err) {
      console.error('Login error:', err);
      showError('Connection error. Please try again.');
    } finally {
      loginBtn.classList.remove('loading');
      loginBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Send Verification Code</span>';
    }
  });

  // Step 2: Verify code
  verifyBtn.addEventListener('click', async () => {
    const code = codeInput.value.trim();

    if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
      showError('Please enter a valid 6-digit code');
      codeInput.classList.add('error-field');
      return;
    }

    if (!pendingStudent || !pendingStudentId) {
      showError('Session expired. Please login again.');
      resetToLogin();
      return;
    }

    // Check if code expired (5 minutes)
    if (Date.now() - pendingStudent.timestamp > 5 * 60 * 1000) {
      showError('Code expired. Please request a new one.');
      resetToLogin();
      return;
    }

    // Verify code
    if (code !== current2FACode) {
      showError('Invalid verification code');
      codeInput.classList.add('error-field');
      return;
    }

    // Success!
    verifyBtn.classList.add('loading');
    verifyBtn.innerHTML = '<i class="fas fa-spinner"></i> Verifying...';

    // Clear timer
    if (timerInterval) clearInterval(timerInterval);

    // Save session with both ID and data
    sessionStorage.setItem('studentSession', JSON.stringify({
      id: pendingStudentId,
      ...pendingStudent,
      loginTime: new Date().toISOString(),
      verified: true
    }));

    // Log login in Firestore
    try {
      await updateDoc(doc(db, 'students', pendingStudentId), {
        lastLogin: serverTimestamp(),
        lastLoginEmail: pendingStudent.email
      });
    } catch (err) {
      console.error('Failed to log login:', err);
    }

    showSuccess('Login successful! Redirecting...');

    // Redirect based on role
    setTimeout(() => {
      if (pendingStudent.role === 'rep') {
        window.location.href = 'rep-dashboard.html';
      } else {
        window.location.href = 'student-dashboard.html';
      }
    }, 800);
  });

  // Resend code
  resendBtn.addEventListener('click', async () => {
    if (!pendingStudent) {
      showError('Session expired. Please login again.');
      resetToLogin();
      return;
    }

    resendBtn.classList.add('loading');
    resendBtn.innerHTML = '<i class="fas fa-spinner"></i> Sending...';

    // Generate new code
    current2FACode = generate2FACode();
    pendingStudent.timestamp = Date.now();

    // Send new code
    await sendVerificationEmail(pendingStudent.email, current2FACode, pendingStudent.fullName);

    // Reset timer
    if (timerInterval) clearInterval(timerInterval);
    startTimer(300);

    resendBtn.classList.remove('loading');
    resendBtn.innerHTML = '<i class="fas fa-redo-alt"></i><span>Resend Code</span>';
    
    showSuccess('New code sent!');
  });

  // Helper function to reset to login form
  function resetToLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('verificationSection').style.display = 'none';
    if (timerInterval) clearInterval(timerInterval);
    current2FACode = null;
    pendingStudent = null;
    pendingStudentId = null;
  }

  // Enter key support
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      if (document.getElementById('verificationSection').style.display === 'block') {
        verifyBtn.click();
      } else {
        loginBtn.click();
      }
    }
  });
});
</script>
</body>
</html>
